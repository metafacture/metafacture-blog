{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025-03-10-fixing-memory-leak/","result":{"data":{"site":{"siteMetadata":{"title":"Metafacture Blog"}},"markdownRemark":{"id":"2ea08c2e-142c-53b9-8c61-280f9a6f5054","excerpt":"Some  classes (e.g. the ubiquitous  (which is invoked when loading a file as a table (like a CSV) in your ETL scripts)\nused uncloseable resources, which would‚Ä¶","html":"<p>Some <code class=\"language-text\">metafacture-core</code> classes (e.g. the ubiquitous <a href=\"https://github.com/metafacture/metafacture-core/blob/master/metamorph/src/main/java/org/metafacture/metamorph/maps/FileMap.java\"><code class=\"language-text\">FileMap</code></a> (which is invoked when loading a file as a table (like a CSV) in your ETL scripts)\nused uncloseable resources, which would leak memory, <a href=\"https://github.com/metafacture/metafacture-core/issues/666\">resulting ultimately in a\n‚ÄúOutOfMemoryError: Java heap space‚Äù</a> since at least 2013 (back then the class was\ncalled <code class=\"language-text\">MapFile</code>).</p>\n<h2 id=\"preconditions\" style=\"position:relative;\"><a href=\"#preconditions\" aria-label=\"preconditions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Preconditions</h2>\n<p>Affected were all usages of Metafacture which instantiate a <code class=\"language-text\">Flux</code> multiple times\nover the lifecycle of one JVM. While this is an obvious statement, we could\nexperience the leaking of memory at the earliest since March 2021 when we\nchanged how to start our ETL processes for lobid-resources: Back in the early days we invoked\nthe ETL by starting a new JVM, run our workflow and terminate the JVM afterwards.\nComing with the <a href=\"https://github.com/hbz/lobid-resources/issues/1159\">Webhook in March 2021</a>\nthe JVM was not terminated after an ETL but listened further for incoming ETL\ntriggering. In principle the JVM should have only been restarted when new code\nwas to be deployed, but we soon discovered that restarting <a href=\"https://github.com/hbz/lobid-resources/tree/master/web\">our Play app</a>\njust before the weekly fresh and complete ETL of > 24 million documents improved\nthe performance and averted some hanging processes or crashes.</p>\n<p>We also have a monitoring tool installed on our servers which checks for terminated processes\nand restarts them automatically. This happened often after some\nmore ETL processes were invoked (the ‚Äúdaily updates‚Äù).\nIt was unclear why these crashes appeared but by assigning more RAM and\n(automatically) restarting the whole JVM after crashes the ETL process went\nstable enough.</p>\n<h2 id=\"plotting-the-leak\" style=\"position:relative;\"><a href=\"#plotting-the-leak\" aria-label=\"plotting the leak permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Plotting the leak</h2>\n<p>Since 2025 we started the <a href=\"https://github.com/hbz/rpb/\">Rheinland-Pf√§lzische Bibliografie (RPB)</a>.\nHere, ETL processes are triggered <em>every time</em> a record is changed or created.\nThis resulted very quickly in an\n<a href=\"https://github.com/hbz/lobid-resources/issues/2121#issuecomment-2631355294\">OutOfMemoryError</a>.</p>\n<p>Using Intellij IDEA we can easily produce a picture which shows the ever\nincreasing demand of memory:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/121f09de5db4c031f7c4831a42402660/5d72a/intellijIdeaGraphShowingMemoryLeak.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.37974683544304%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAC4jAAAuIwF4pT92AAABZElEQVR42oXQzUrDQBAH8G3aNLvZTdoak22TNK1KaRE0/bCtB7WIF0VBURF9AqF49yG8e/PoUdCDF98j97xI8jf9wqOHHzPMDDMwZN2Wse244JynjFFwQ1/i4ILPc50viawu9L+ZVV/oCdUZDMOIiGmWYtdrolrzUyk9WOUaKsKBoAYURQEh5F8FRUlKwoRGaUQ0TYsppaAaS0VZYPjUwWi6jdZZgK0LD/WJRKlhwAw41toCTmiitm9CdgVa1zbadxLho5+MnjfgH1kR4UyNC/n5pVQp5uAMDFRHOuxuEbKnQYYqrLYCZ0dDdZAtG1vwDlx4h9mCSbCS+MdNlOrliKiqGudyOWTSWSSkCEV1Qe0xeOMc5d4U9skL7NNXOOdvkJfvqN58wL3/Ru32c+krcR9+YHauIiJYMa7wQvazfDr7mcoEdGcTPOhDDwaZvcxwod4Hq/fAvBDM3V3EhYT5XWimjH4BzFibEf8trNYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot of the graph showing the increasing demand of memory\"\n        title=\"\"\n        src=\"/static/121f09de5db4c031f7c4831a42402660/f058b/intellijIdeaGraphShowingMemoryLeak.png\"\n        srcset=\"/static/121f09de5db4c031f7c4831a42402660/c26ae/intellijIdeaGraphShowingMemoryLeak.png 158w,\n/static/121f09de5db4c031f7c4831a42402660/6bdcf/intellijIdeaGraphShowingMemoryLeak.png 315w,\n/static/121f09de5db4c031f7c4831a42402660/f058b/intellijIdeaGraphShowingMemoryLeak.png 630w,\n/static/121f09de5db4c031f7c4831a42402660/5d72a/intellijIdeaGraphShowingMemoryLeak.png 834w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nAt the beginning (at the left) we see that the CPU (green colored) is heavily used\nfor all classes are compiled and loaded. Then we see how the Heap Memory (blue\ncolored) is filled and after some time there are some spikes, indicating that\nthe Garbage Collector was able to free some unused memory.\nWe can see how the memory\nconsumption is ascending nonetheless. Then a long line appears, lacking all\nspikes. This happens when there is less and less memory which the\ngarbage collector could release. We can see 5 peaks where the CPU heavily\nworks - this is the garbage collector trying to find some piece of memory\nto free - without much avail. The app crashes shortly after that (not to be\nseen).</p>\n<h2 id=\"one-fix-several-problems-solved\" style=\"position:relative;\"><a href=\"#one-fix-several-problems-solved\" aria-label=\"one fix several problems solved permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>One fix, several problems solved</h2>\n<p>After <a href=\"https://github.com/metafacture/metafacture-core/commit/b32609307f75187a6a3822b8a951429c7fc924f3\">fixing the memory leak</a>\nthe consumption of memory is normal, i.e. not ascending:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.746835443037973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAC4jAAAuIwF4pT92AAABIklEQVR42n3QSU8CQRCG4d5mhhmWWRhgNgniwbhw8ICGBCIcDIRw9p940xPhb89rg1xI1MOTquqkKulPdNOcOOljjEYqgZQ/jrMxBuMYHNc5M39yPbcOggAxHk+YTObcP8zo9YZEUWkVOI6LOB7XEiHEv6SQGGlq97iz2Xyx2x3Ybve27lmvDyxXn7SbA7xYMf244fa9tAqq15RqmZK9JORWOe+SPSen2b7X6V2IaPkuWmm0vqSkwniaaBQQXzeIRy5hpU86haKTq3OVpz6sVN1KDcKxWelzdr9/yUN4JaLziEynyN4MlS2QgwWqfEMVK1S+RJbr2vSfEEknoBf6tIKGDdbDu9DAa4Y02il+mOFHuVXgx5VV4idX595KhnUQZXwD3QSQ5FPp1qYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot of the graph showing normal consumption of memory\"\n        title=\"\"\n        src=\"/static/5efff03a0281e360439ed468dd196099/f058b/intellijIdeaGraphShowingMemoryWithoutLeak.png\"\n        srcset=\"/static/5efff03a0281e360439ed468dd196099/c26ae/intellijIdeaGraphShowingMemoryWithoutLeak.png 158w,\n/static/5efff03a0281e360439ed468dd196099/6bdcf/intellijIdeaGraphShowingMemoryWithoutLeak.png 315w,\n/static/5efff03a0281e360439ed468dd196099/f058b/intellijIdeaGraphShowingMemoryWithoutLeak.png 630w,\n/static/5efff03a0281e360439ed468dd196099/f73a1/intellijIdeaGraphShowingMemoryWithoutLeak.png 822w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\nEvery spike indicates that memory resources were freed, resulting in a stable\nrise and fall of CPU and memory usage. The memory leak is really fixed. üòÄ</p>\n<p>Fixing the memory leak in Metafacture resolved some issues we‚Äôve experienced:</p>\n<ul>\n<li>lobid-resources: daily updates sometimes aborted - although this was not such a big thing because our monitor scripts could ‚Äúheal‚Äù the update process automatically (by restarting the app). However, the updates now don‚Äôt take e.g. 4h (counting from triggering the update until the successful ETL) but 0.45m, which is way faster.</li>\n<li>Metafacture Playground: we had some <a href=\"https://github.com/metafacture/metafacture-playground/issues/194\">performance issues</a> which are now solved.</li>\n<li>RPB: a situation arose where we could only ever add more memory to our VMs to counteract a crash of cataloguing - always fearing that not too much documents were ETLed before the daily restart of the cataloguing app.</li>\n</ul>\n<h2 id=\"how-to-and-credits\" style=\"position:relative;\"><a href=\"#how-to-and-credits\" aria-label=\"how to and credits permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to and credits</h2>\n<p>It is <em>one</em> thing to discover a memory leak, but another thing to\ndetermine where the source of that leak <em>exactly</em> is.\nI have to thank e.g. <a href=\"https://medium.com/@chrisbrat_17048/java-memory-leak-investigation-8add1314e33b\">Chris Braithwaite for his excellent blog post concerning Java memory leaks</a> to gain a bit more of the background of what a Java memory leak is.\nVery useful for me was the built-in profiler in Intellij IDEA. It not only\nhas helped to plot the graphs (see above) to see at a glance that there indeed is a\nmemory leak, but can also capture memory snapshots and profile the CPU usage\nto find the problematic classes. It would show something like this:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.58227848101266%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA6cAAAOnAEHlFPdAAABIElEQVR42mNgYWFhZGRiZGRkYGAAkyAGhOTjEZEW15CR0BTklxARkpUQUZKV1BQXVmRhZlWU0RcRkmJgZmYBqhPgE+HlFgQyWFnYgSQ7G6eokKyclJaHXYq5ga+lUYCLTYy8lK6euqO2qq2wgLSZno+6ihGDlpqZkryus02ko1WEnLSWsa6rnXmgo1VogHu2lbF/iHdRkEe+j3Omn2umkba7g2WEjUmIjqq9h32ymZErQ2J4fUJYQ1xodVxoTWxQTbhPeahXWZB7SYBroY9TZqh3Yah3cYhXsY9Ttrtdip9rcph3nLdzWphPqZ1FIENscEV0UFlMcEWYT4mfS66PY7anfSYQedlneTvkeDtkI6G8MO+UtMiYEO/8SL9yN/toAEVYQ0Agt08fAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot of the graph showing normal consumption of memory\"\n        title=\"\"\n        src=\"/static/4e5e62bf1a1889fc41ea8a8dd42dbad5/f058b/intellijIdeaProfilingProcesses.png\"\n        srcset=\"/static/4e5e62bf1a1889fc41ea8a8dd42dbad5/c26ae/intellijIdeaProfilingProcesses.png 158w,\n/static/4e5e62bf1a1889fc41ea8a8dd42dbad5/6bdcf/intellijIdeaProfilingProcesses.png 315w,\n/static/4e5e62bf1a1889fc41ea8a8dd42dbad5/f058b/intellijIdeaProfilingProcesses.png 630w,\n/static/4e5e62bf1a1889fc41ea8a8dd42dbad5/40601/intellijIdeaProfilingProcesses.png 945w,\n/static/4e5e62bf1a1889fc41ea8a8dd42dbad5/78612/intellijIdeaProfilingProcesses.png 1260w,\n/static/4e5e62bf1a1889fc41ea8a8dd42dbad5/53ac9/intellijIdeaProfilingProcesses.png 1287w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\nIf you have found the class where the memory leak most likely originates from\nyou can make an educated guess of the statement which causes the problem,\nor/and by commenting in/out the likely code, tracking down the problematic code.</p>","frontmatter":{"title":"Fixing a memory leak","date":"March 17, 2025","authors":[{"lastname":"Christoph","firstname":"Pascal"}],"description":"How we were affected by a memory leak and how we fixed it"}},"previous":{"fields":{"slug":"/metafacture-releases_core-6.2.0_fix-1.2.0/"},"frontmatter":{"title":"Metafacture releases: Core 6.2.0, Fix 1.2.0"}},"next":{"fields":{"slug":"/metafacture-releases_core-7.0.0/"},"frontmatter":{"title":"Metafacture releases: Core 7.0.0"}}},"pageContext":{"id":"2ea08c2e-142c-53b9-8c61-280f9a6f5054","previousPostId":"05ead502-0157-5031-903e-9aea1c6906be","nextPostId":"23016d04-88c4-5ea7-ba4e-dbad01b250d3"}},"staticQueryHashes":["3000541721","3481160139","3958154028"],"slicesMap":{}}